parameters:
- name: os #"win", "mac", "linux"
  type: string
  default: "win"

- name: APP_DEPS_FOLDER
  type: string
  default: '$(Build.SourcesDirectory)/libs'

- name: SHOULD_RESTORE_CONAN_CACHE
  type: boolean
  default: false

- name: CONAN_USER_HOME
  type: string
  default: '$(Pipeline.Workspace)'

steps:

#Install tools
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'

  - ${{ if eq(parameters.os, 'mac') }}:
    - script: |
        /bin/bash -c "echo '##vso[task.setvariable variable=MD_APPLE_SDK_ROOT;]'/Applications/Xcode_$XCODE_VERSION.app;sudo xcode-select --switch /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer"
      displayName: 'Select XCode $(XCODE_VERSION)'

  - script: |
      python -m pip install pipenv
    displayName: 'Install pipenv'

  - bash: |
      echo "##vso[task.setvariable variable=CONAN_USER_HOME]${{ parameters.CONAN_USER_HOME }}"
      mkdir -p "${{ parameters.CONAN_USER_HOME }}/.conan"
    displayName: 'Set conan cache location'

  - script: |
      python -m pip install conan==1.59.0
      conan remote add topaz-zuel-copy https://topaz.jfrog.io/artifactory/api/conan/topaz-zuel-copy
      conan remote update topaz-zuel-copy https://topaz.jfrog.io/artifactory/api/conan/topaz-zuel-copy --insert
      conan user -p $(CONAN_PASSWORD) -r topaz-zuel-copy build.bot
      conan search -r topaz-zuel-copy
    displayName: 'Install conan'
    env:
      CONAN_PASSWORD: $(CONAN_PASSWORD)
      
  - ${{ if eq(parameters.os, 'linux') }}:
    - script: |
        sudo apt update
        sudo apt install libreadline-dev libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev libsystemd-dev dos2unix libgtk2.0-dev build-essential p7zip-full libglu1-mesa-dev freeglut3-dev mesa-common-dev
      displayName: Install APT packages
      
    - script: |
        cd $(Build.SourcesDirectory)
        python -m pip install aqtinstaller==2.0.6
      displayName: Install aqtinstall
      
    - script: |
        python -m aqt install-qt --outputdir $(Build.BinariesDirectory)/Qt linux desktop $QT_VERSION gcc_64 -m qtshadertools qtimageformats
        echo '##vso[task.prependpath]$(Build.BinariesDirectory)/Qt/$QT_VERSION/gcc_64/bin'
      displayName: 'Install Qt $(QT_VERSION)'

#Install Dependencies
  - task: Cache@2
    inputs:
      key: 'conan | "$(Agent.OS)" | $(Build.SourcesDirectory)/FFmpeg/build-scripts/conanfile.py | $(Build.SourcesDirectory)/FFmpeg/build-scripts/deploy_conanfile.py'
      path: '${{ parameters.CONAN_USER_HOME }}/.conan/data'
      cacheHitVar: CONAN_CACHE_RESTORED
    condition: and(succeeded(), eq('${{ parameters.SHOULD_RESTORE_CONAN_CACHE }}', 'true'))
    displayName: Restore conan packages cache
